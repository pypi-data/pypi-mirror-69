##################### generated by xml-casa (v2) from importmiriad.xml ##############
##################### 717325a8878ef5e5e2ae5e5f1cf8af4c ##############################
from __future__ import absolute_import
from casashell.private.stack_manip import find_local as __sf__
from casashell.private.stack_manip import find_frame as _find_frame
from casatools.typecheck import validator as _pc
from casatools.coercetype import coerce as _coerce
from casatasks import importmiriad as _importmiriad_t
from collections import OrderedDict
import sys
import os

def static_var(varname, value):
    def decorate(func):
        setattr(func, varname, value)
        return func
    return decorate

class _importmiriad:
    """
    importmiriad ---- Convert a Miriad visibility file into a CASA MeasurementSet

    
    Convert a Miriad visibility file into a CASA MeasurementSet with
    optional selection of spectral windows and weighting scheme
    

    --------- parameter descriptions ---------------------------------------------

    mirfile Name of input Miriad visibility file
            Default: none
            
               Example: mirfile='mydata.uv'
    vis     Name of output MeasurementSet
            Default: none
            
               Example: vis='mydata.ms'
    tsys    Use the Tsys to set the visibility weights
            Default: False
            Options: False|True
    spw     Select spectral window/channels
                      Default: '' (all spectral windows and channels)
            
                         Examples:
                         spw='0~2,4'; spectral windows 0,1,2,4 (all channels)
                         spw='<2';  spectral windows less than 2 (i.e. 0,1)
                         spw='0:5~61'; spw 0, channels 5 to 61
                         spw='0,10,3:3~45'; spw 0,10 all channels, spw
                         3 - chans 3 to 45.
                         spw='0~2:2~6'; spw 0,1,2 with channels 2
                         through 6 in each.
                         spw = '*:3~64'  channels 3 through 64 for all sp id's
                         spw = ' :3~64' will NOT work.
    vel     Select velocity reference
            Default: telescope dependent, ATCA -> TOPO, CARMA
            -> LSRK
            Options: TOPO|LSRK|LSRD
            
               Example: vel='LSRK'
    linecal (CARMA) Apply line calibration
                                Default: False
                                Options: False|True
            
                                Only useful for CARMA data
    wide    (CARMA) Select wide window averages
            
            Select which of the wide-band channels should be loaded 
            Only useful for CARMA data
    debug   Display increasingly verbose debug messages
            Default: 0
            
               Example: debug=1
    [1;42mRETURNS[1;m    void

    --------- examples -----------------------------------------------------------

    
    FOR MORE INFORMATION, SEE THE TASK PAGES OF IMPORTMIRIAD IN CASA DOCS:
    https://casa.nrao.edu/casadocs/
    


    """

    _info_group_ = """import/export"""
    _info_desc_ = """Convert a Miriad visibility file into a CASA MeasurementSet"""

    __schema = {'mirfile': {'type': 'cReqPath', 'coerce': _coerce.expand_path}, 'vis': {'type': 'cStr'}, 'tsys': {'type': 'cBool'}, 'spw': {'type': 'cIntVec', 'coerce': [_coerce.to_list,_coerce.to_intvec]}, 'vel': {'type': 'cStr'}, 'linecal': {'type': 'cBool'}, 'wide': {'type': 'cIntVec', 'coerce': [_coerce.to_list,_coerce.to_intvec]}, 'debug': {'type': 'cInt'}}

    def __init__(self):
        self.__stdout = None
        self.__stderr = None
        self.__root_frame_ = None

    def __globals_(self):
        if self.__root_frame_ is None:
            self.__root_frame_ = _find_frame( )
            assert self.__root_frame_ is not None, "could not find CASAshell global frame"
        return self.__root_frame_

    def __to_string_(self,value):
        if type(value) is str:
            return "'%s'" % value
        else:
            return str(value)

    def __validate_(self,doc,schema):
        return _pc.validate(doc,schema)

    #--------- return nonsubparam values ----------------------------------------------

    def __vis_dflt( self, glb ):
        return ''

    def __vis( self, glb ):
        if 'vis' in glb: return glb['vis']
        return ''

    def __vel_dflt( self, glb ):
        return ''

    def __vel( self, glb ):
        if 'vel' in glb: return glb['vel']
        return ''

    def __mirfile_dflt( self, glb ):
        return ''

    def __mirfile( self, glb ):
        if 'mirfile' in glb: return glb['mirfile']
        return ''

    def __debug_dflt( self, glb ):
        return int(0)

    def __debug( self, glb ):
        if 'debug' in glb: return glb['debug']
        return int(0)

    def __spw_dflt( self, glb ):
        return [ int(-1) ]

    def __spw( self, glb ):
        if 'spw' in glb: return glb['spw']
        return [ int(-1) ]

    def __wide_dflt( self, glb ):
        return [  ]

    def __wide( self, glb ):
        if 'wide' in glb: return glb['wide']
        return [  ]

    def __linecal_dflt( self, glb ):
        return False

    def __linecal( self, glb ):
        if 'linecal' in glb: return glb['linecal']
        return False

    def __tsys_dflt( self, glb ):
        return False

    def __tsys( self, glb ):
        if 'tsys' in glb: return glb['tsys']
        return False



    #--------- return inp/go default --------------------------------------------------


    #--------- return subparam values -------------------------------------------------


    #--------- subparam inp output ----------------------------------------------------
    def __mirfile_inp(self):
        out = self.__stdout or sys.stdout
        description = 'Name of input Miriad visibility file'
        value = self.__mirfile( self.__globals_( ) )
        (pre,post) = ('','') if self.__validate_({'mirfile': value},{'mirfile': self.__schema['mirfile']}) else ('\x1B[91m','\x1B[0m')
        out.write('%-7.7s = %s%-23.22s%s # %-.60s\n' % ('mirfile',pre,self.__to_string_(value),post,description))
    def __vis_inp(self):
        out = self.__stdout or sys.stdout
        description = 'Name of output MeasurementSet'
        value = self.__vis( self.__globals_( ) )
        (pre,post) = ('','') if self.__validate_({'vis': value},{'vis': self.__schema['vis']}) else ('\x1B[91m','\x1B[0m')
        out.write('%-7.7s = %s%-23.22s%s # %-.60s\n' % ('vis',pre,self.__to_string_(value),post,description))
    def __tsys_inp(self):
        out = self.__stdout or sys.stdout
        description = 'Use the Tsys to set the visibility weights'
        value = self.__tsys( self.__globals_( ) )
        (pre,post) = ('','') if self.__validate_({'tsys': value},{'tsys': self.__schema['tsys']}) else ('\x1B[91m','\x1B[0m')
        out.write('%-7.7s = %s%-23.22s%s # %-.60s\n' % ('tsys',pre,self.__to_string_(value),post,description))
    def __spw_inp(self):
        out = self.__stdout or sys.stdout
        description = 'Select spectral window/channels'
        value = self.__spw( self.__globals_( ) )
        (pre,post) = ('','') if self.__validate_({'spw': value},{'spw': self.__schema['spw']}) else ('\x1B[91m','\x1B[0m')
        out.write('%-7.7s = %s%-23.22s%s # %-.60s\n' % ('spw',pre,self.__to_string_(value),post,description))
    def __vel_inp(self):
        out = self.__stdout or sys.stdout
        description = 'Select velocity reference (TOPO,LSRK,LSRD)'
        value = self.__vel( self.__globals_( ) )
        (pre,post) = ('','') if self.__validate_({'vel': value},{'vel': self.__schema['vel']}) else ('\x1B[91m','\x1B[0m')
        out.write('%-7.7s = %s%-23.22s%s # %-.60s\n' % ('vel',pre,self.__to_string_(value),post,description))
    def __linecal_inp(self):
        out = self.__stdout or sys.stdout
        description = '(CARMA) Apply line calibration'
        value = self.__linecal( self.__globals_( ) )
        (pre,post) = ('','') if self.__validate_({'linecal': value},{'linecal': self.__schema['linecal']}) else ('\x1B[91m','\x1B[0m')
        out.write('%-7.7s = %s%-23.22s%s # %-.60s\n' % ('linecal',pre,self.__to_string_(value),post,description))
    def __wide_inp(self):
        out = self.__stdout or sys.stdout
        description = '(CARMA) Select wide window averages'
        value = self.__wide( self.__globals_( ) )
        (pre,post) = ('','') if self.__validate_({'wide': value},{'wide': self.__schema['wide']}) else ('\x1B[91m','\x1B[0m')
        out.write('%-7.7s = %s%-23.22s%s # %-.60s\n' % ('wide',pre,self.__to_string_(value),post,description))
    def __debug_inp(self):
        out = self.__stdout or sys.stdout
        description = 'Display increasingly verbose debug messages'
        value = self.__debug( self.__globals_( ) )
        (pre,post) = ('','') if self.__validate_({'debug': value},{'debug': self.__schema['debug']}) else ('\x1B[91m','\x1B[0m')
        out.write('%-7.7s = %s%-23.22s%s # %-.60s\n' % ('debug',pre,self.__to_string_(value),post,description))

    #--------- global default implementation-------------------------------------------
    @static_var('state', __sf__('casa_inp_go_state'))
    def set_global_defaults(self):
        self.set_global_defaults.state['last'] = self
        glb = self.__globals_( )
        if 'linecal' in glb: del glb['linecal']
        if 'mirfile' in glb: del glb['mirfile']
        if 'vel' in glb: del glb['vel']
        if 'vis' in glb: del glb['vis']
        if 'tsys' in glb: del glb['tsys']
        if 'debug' in glb: del glb['debug']
        if 'wide' in glb: del glb['wide']
        if 'spw' in glb: del glb['spw']


    #--------- inp function -----------------------------------------------------------
    def inp(self):
        self.__mirfile_inp( )
        self.__vis_inp( )
        self.__tsys_inp( )
        self.__spw_inp( )
        self.__vel_inp( )
        self.__linecal_inp( )
        self.__wide_inp( )
        self.__debug_inp( )

    #--------- tget function ----------------------------------------------------------
    def tget(self,file=None):
        from .stack_manip import find_frame
        from runpy import run_path
        filename = None
        if file is None:
            if os.path.isfile("importmiriad.last"):
                filename = "importmiriad.last"
        elif isinstance(file, str):
            if os.path.isfile(file):
                filename = file
        if filename is not None:
            glob = find_frame( )
            newglob = run_path( filename, init_globals={ } )
            for i in newglob:
                glob[i] = newglob[i]

    def __call__( self, mirfile=None, vis=None, tsys=None, spw=None, vel=None, linecal=None, wide=None, debug=None ):
        def noobj(s):
           if s.startswith('<') and s.endswith('>'):
               return "None"
           else:
               return s
        _prefile = os.path.realpath('importmiriad.pre')
        _postfile = os.path.realpath('importmiriad.last')
        _return_result_ = None
        _arguments = [mirfile,vis,tsys,spw,vel,linecal,wide,debug]
        _invocation_parameters = OrderedDict( )
        if any(map(lambda x: x is not None,_arguments)):
            # invoke python style
            # set the non sub-parameters that are not None
            local_global = { }
            if mirfile is not None: local_global['mirfile'] = mirfile
            if vis is not None: local_global['vis'] = vis
            if tsys is not None: local_global['tsys'] = tsys
            if spw is not None: local_global['spw'] = spw
            if vel is not None: local_global['vel'] = vel
            if linecal is not None: local_global['linecal'] = linecal
            if wide is not None: local_global['wide'] = wide
            if debug is not None: local_global['debug'] = debug

            # the invocation parameters for the non-subparameters can now be set - this picks up those defaults
            _invocation_parameters['mirfile'] = self.__mirfile( local_global )
            _invocation_parameters['vis'] = self.__vis( local_global )
            _invocation_parameters['tsys'] = self.__tsys( local_global )
            _invocation_parameters['spw'] = self.__spw( local_global )
            _invocation_parameters['vel'] = self.__vel( local_global )
            _invocation_parameters['linecal'] = self.__linecal( local_global )
            _invocation_parameters['wide'] = self.__wide( local_global )
            _invocation_parameters['debug'] = self.__debug( local_global )

            # the sub-parameters can then be set. Use the supplied value if not None, else the function, which gets the appropriate default
            

        else:
            # invoke with inp/go semantics
            _invocation_parameters['mirfile'] = self.__mirfile( self.__globals_( ) )
            _invocation_parameters['vis'] = self.__vis( self.__globals_( ) )
            _invocation_parameters['tsys'] = self.__tsys( self.__globals_( ) )
            _invocation_parameters['spw'] = self.__spw( self.__globals_( ) )
            _invocation_parameters['vel'] = self.__vel( self.__globals_( ) )
            _invocation_parameters['linecal'] = self.__linecal( self.__globals_( ) )
            _invocation_parameters['wide'] = self.__wide( self.__globals_( ) )
            _invocation_parameters['debug'] = self.__debug( self.__globals_( ) )
        try:
            with open(_prefile,'w') as _f:
                for _i in _invocation_parameters:
                    _f.write("%-7s = %s\n" % (_i,noobj(repr(_invocation_parameters[_i]))))
                _f.write("#importmiriad( ")
                count = 0
                for _i in _invocation_parameters:
                    _f.write("%s=%s" % (_i,noobj(repr(_invocation_parameters[_i]))))
                    count += 1
                    if count < len(_invocation_parameters): _f.write(",")
                _f.write(" )\n")
        except: pass
        try:
            _return_result_ = _importmiriad_t( _invocation_parameters['mirfile'],_invocation_parameters['vis'],_invocation_parameters['tsys'],_invocation_parameters['spw'],_invocation_parameters['vel'],_invocation_parameters['linecal'],_invocation_parameters['wide'],_invocation_parameters['debug'] )
        except: _return_result_ = False
        try:
            os.rename(_prefile,_postfile)
        except: pass
        return _return_result_

importmiriad = _importmiriad( )

