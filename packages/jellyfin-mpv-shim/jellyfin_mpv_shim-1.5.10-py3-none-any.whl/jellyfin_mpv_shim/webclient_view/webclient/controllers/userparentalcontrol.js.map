{"version":3,"sources":["controllers/userparentalcontrol.js"],"names":["define","$","datetime","loading","libraryMenu","loadUser","page","user","allParentalRatings","querySelector","innerHTML","Name","setTitle","loadUnratedItems","items","name","Globalize","translate","value","html","i","length","item","checkedAttribute","Policy","BlockUnratedItems","indexOf","trigger","loadBlockedTags","BlockedTags","populateRatings","rating","ratings","lastRating","Value","push","ratingValue","MaxParentalRating","val","IsAdministrator","hide","show","renderAccessSchedule","AccessSchedules","tags","map","h","li","join","elem","on","tag","this","getAttribute","newTags","filter","t","schedules","index","a","itemHtml","DayOfWeek","StartHour","EndHour","getDisplayTime","accessScheduleList","deleteAccessSchedule","splice","parseInt","saveUser","get","checked","getSchedulesFromPage","getBlockedTagsFromPage","ApiClient","updateUserPolicy","Id","then","onSaveComplete","require","toast","hours","minutes","pct","Date","window","UserParentalControlPage","onSubmit","parents","userId","getParameterByName","getUser","result","document","showSchedulePopup","schedule","accessschedule","updatedSchedule","showBlockedTagPopup","prompt","label","off","promise1","promise2","getParentalRatings","Promise","all","responses"],"mappings":"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","file":"userparentalcontrol.js","sourcesContent":["define([\"jQuery\", \"datetime\", \"loading\", \"libraryMenu\", \"listViewStyle\", \"paper-icon-button-light\"], function ($, datetime, loading, libraryMenu) {\n    \"use strict\";\n\n    function populateRatings(allParentalRatings, page) {\n        var html = \"\";\n        html += \"<option value=''></option>\";\n        var i;\n        var length;\n        var rating;\n        var ratings = [];\n\n        for (i = 0, length = allParentalRatings.length; i < length; i++) {\n            if (rating = allParentalRatings[i], ratings.length) {\n                var lastRating = ratings[ratings.length - 1];\n\n                if (lastRating.Value === rating.Value) {\n                    lastRating.Name += \"/\" + rating.Name;\n                    continue;\n                }\n            }\n\n            ratings.push({\n                Name: rating.Name,\n                Value: rating.Value\n            });\n        }\n\n        for (i = 0, length = ratings.length; i < length; i++) {\n            rating = ratings[i];\n            html += \"<option value='\" + rating.Value + \"'>\" + rating.Name + \"</option>\";\n        }\n\n        $(\"#selectMaxParentalRating\", page).html(html);\n    }\n\n    function loadUnratedItems(page, user) {\n        var items = [{\n            name: Globalize.translate(\"OptionBlockBooks\"),\n            value: \"Book\"\n        }, {\n            name: Globalize.translate(\"OptionBlockChannelContent\"),\n            value: \"ChannelContent\"\n        }, {\n            name: Globalize.translate(\"OptionBlockLiveTvChannels\"),\n            value: \"LiveTvChannel\"\n        }, {\n            name: Globalize.translate(\"OptionBlockMovies\"),\n            value: \"Movie\"\n        }, {\n            name: Globalize.translate(\"OptionBlockMusic\"),\n            value: \"Music\"\n        }, {\n            name: Globalize.translate(\"OptionBlockTrailers\"),\n            value: \"Trailer\"\n        }, {\n            name: Globalize.translate(\"OptionBlockTvShows\"),\n            value: \"Series\"\n        }];\n        var html = \"\";\n        html += '<h3 class=\"checkboxListLabel\">' + Globalize.translate(\"HeaderBlockItemsWithNoRating\") + \"</h3>\";\n        html += '<div class=\"checkboxList paperList checkboxList-paperList\">';\n\n        for (var i = 0, length = items.length; i < length; i++) {\n            var item = items[i];\n            var checkedAttribute = -1 != user.Policy.BlockUnratedItems.indexOf(item.value) ? ' checked=\"checked\"' : \"\";\n            html += '<label><input type=\"checkbox\" is=\"emby-checkbox\" class=\"chkUnratedItem\" data-itemtype=\"' + item.value + '\" type=\"checkbox\"' + checkedAttribute + \"><span>\" + item.name + \"</span></label>\";\n        }\n\n        html += \"</div>\";\n        $(\".blockUnratedItems\", page).html(html).trigger(\"create\");\n    }\n\n    function loadUser(page, user, allParentalRatings) {\n        page.querySelector(\".username\").innerHTML = user.Name;\n        libraryMenu.setTitle(user.Name);\n        loadUnratedItems(page, user);\n        loadBlockedTags(page, user.Policy.BlockedTags);\n        populateRatings(allParentalRatings, page);\n        var ratingValue = \"\";\n\n        if (user.Policy.MaxParentalRating) {\n            for (var i = 0, length = allParentalRatings.length; i < length; i++) {\n                var rating = allParentalRatings[i];\n\n                if (user.Policy.MaxParentalRating >= rating.Value) {\n                    ratingValue = rating.Value;\n                }\n            }\n        }\n\n        $(\"#selectMaxParentalRating\", page).val(ratingValue);\n\n        if (user.Policy.IsAdministrator) {\n            $(\".accessScheduleSection\", page).hide();\n        } else {\n            $(\".accessScheduleSection\", page).show();\n        }\n\n        renderAccessSchedule(page, user.Policy.AccessSchedules || []);\n        loading.hide();\n    }\n\n    function loadBlockedTags(page, tags) {\n        var html = tags.map(function (h) {\n            var li = '<div class=\"listItem\">';\n            li += '<div class=\"listItemBody\">';\n            li += '<h3 class=\"listItemBodyText\">';\n            li += h;\n            li += \"</h3>\";\n            li += \"</div>\";\n            li += '<button type=\"button\" is=\"paper-icon-button-light\" class=\"blockedTag btnDeleteTag listItemButton\" data-tag=\"' + h + '\"><i class=\"material-icons\">delete</i></button>';\n            return li += \"</div>\";\n        }).join(\"\");\n\n        if (html) {\n            html = '<div class=\"paperList\">' + html + \"</div>\";\n        }\n\n        var elem = $(\".blockedTags\", page).html(html).trigger(\"create\");\n        $(\".btnDeleteTag\", elem).on(\"click\", function () {\n            var tag = this.getAttribute(\"data-tag\");\n            var newTags = tags.filter(function (t) {\n                return t != tag;\n            });\n            loadBlockedTags(page, newTags);\n        });\n    }\n\n    function deleteAccessSchedule(page, schedules, index) {\n        schedules.splice(index, 1);\n        renderAccessSchedule(page, schedules);\n    }\n\n    function renderAccessSchedule(page, schedules) {\n        var html = \"\";\n        var index = 0;\n        html += schedules.map(function (a) {\n            var itemHtml = \"\";\n            itemHtml += '<div class=\"liSchedule listItem\" data-day=\"' + a.DayOfWeek + '\" data-start=\"' + a.StartHour + '\" data-end=\"' + a.EndHour + '\">';\n            itemHtml += '<div class=\"listItemBody two-line\">';\n            itemHtml += '<h3 class=\"listItemBodyText\">';\n            itemHtml += Globalize.translate(\"Option\" + a.DayOfWeek);\n            itemHtml += \"</h3>\";\n            itemHtml += '<div class=\"listItemBodyText secondary\">' + getDisplayTime(a.StartHour) + \" - \" + getDisplayTime(a.EndHour) + \"</div>\";\n            itemHtml += \"</div>\";\n            itemHtml += '<button type=\"button\" is=\"paper-icon-button-light\" class=\"btnDelete listItemButton\" data-index=\"' + index + '\"><i class=\"material-icons\">delete</i></button>';\n            itemHtml += \"</div>\";\n            index++;\n            return itemHtml;\n        }).join(\"\");\n        var accessScheduleList = page.querySelector(\".accessScheduleList\");\n        accessScheduleList.innerHTML = html;\n        $(\".btnDelete\", accessScheduleList).on(\"click\", function () {\n            deleteAccessSchedule(page, schedules, parseInt(this.getAttribute(\"data-index\")));\n        });\n    }\n\n    function onSaveComplete(page) {\n        loading.hide();\n\n        require([\"toast\"], function (toast) {\n            toast(Globalize.translate(\"SettingsSaved\"));\n        });\n    }\n\n    function saveUser(user, page) {\n        user.Policy.MaxParentalRating = $(\"#selectMaxParentalRating\", page).val() || null;\n        user.Policy.BlockUnratedItems = $(\".chkUnratedItem\", page).get().filter(function (i) {\n            return i.checked;\n        }).map(function (i) {\n            return i.getAttribute(\"data-itemtype\");\n        });\n        user.Policy.AccessSchedules = getSchedulesFromPage(page);\n        user.Policy.BlockedTags = getBlockedTagsFromPage(page);\n        ApiClient.updateUserPolicy(user.Id, user.Policy).then(function () {\n            onSaveComplete(page);\n        });\n    }\n\n    function getDisplayTime(hours) {\n        var minutes = 0;\n        var pct = hours % 1;\n\n        if (pct) {\n            minutes = parseInt(60 * pct);\n        }\n\n        return datetime.getDisplayTime(new Date(2000, 1, 1, hours, minutes, 0, 0));\n    }\n\n    function showSchedulePopup(page, schedule, index) {\n        schedule = schedule || {};\n\n        require([\"components/accessschedule/accessschedule\"], function (accessschedule) {\n            accessschedule.show({\n                schedule: schedule\n            }).then(function (updatedSchedule) {\n                var schedules = getSchedulesFromPage(page);\n\n                if (-1 == index) {\n                    index = schedules.length;\n                }\n\n                schedules[index] = updatedSchedule;\n                renderAccessSchedule(page, schedules);\n            });\n        });\n    }\n\n    function getSchedulesFromPage(page) {\n        return $(\".liSchedule\", page).map(function () {\n            return {\n                DayOfWeek: this.getAttribute(\"data-day\"),\n                StartHour: this.getAttribute(\"data-start\"),\n                EndHour: this.getAttribute(\"data-end\")\n            };\n        }).get();\n    }\n\n    function getBlockedTagsFromPage(page) {\n        return $(\".blockedTag\", page).map(function () {\n            return this.getAttribute(\"data-tag\");\n        }).get();\n    }\n\n    function showBlockedTagPopup(page) {\n        require([\"prompt\"], function (prompt) {\n            prompt({\n                label: Globalize.translate(\"LabelTag\")\n            }).then(function (value) {\n                var tags = getBlockedTagsFromPage(page);\n\n                if (-1 == tags.indexOf(value)) {\n                    tags.push(value);\n                    loadBlockedTags(page, tags);\n                }\n            });\n        });\n    }\n\n    window.UserParentalControlPage = {\n        onSubmit: function () {\n            var page = $(this).parents(\".page\");\n            loading.show();\n            var userId = getParameterByName(\"userId\");\n            ApiClient.getUser(userId).then(function (result) {\n                saveUser(result, page);\n            });\n            return false;\n        }\n    };\n    $(document).on(\"pageinit\", \"#userParentalControlPage\", function () {\n        var page = this;\n        $(\".btnAddSchedule\", page).on(\"click\", function () {\n            showSchedulePopup(page, {}, -1);\n        });\n        $(\".btnAddBlockedTag\", page).on(\"click\", function () {\n            showBlockedTagPopup(page);\n        });\n        $(\".userParentalControlForm\").off(\"submit\", UserParentalControlPage.onSubmit).on(\"submit\", UserParentalControlPage.onSubmit);\n    }).on(\"pageshow\", \"#userParentalControlPage\", function () {\n        var page = this;\n        loading.show();\n        var userId = getParameterByName(\"userId\");\n        var promise1 = ApiClient.getUser(userId);\n        var promise2 = ApiClient.getParentalRatings();\n        Promise.all([promise1, promise2]).then(function (responses) {\n            loadUser(page, responses[0], responses[1]);\n        });\n    });\n});\n"]}