{"version":3,"sources":["libraries/apiclient/localassetmanager.js"],"names":["define","filerepository","itemrepository","useractionrepository","transfermanager","getLocalItem","serverId","itemId","console","debug","get","deleteUserAction","action","remove","Id","getServerItems","getAll","normalizeId","id","stripStart","sortItems","items","query","SortBy","length","shuffle","array","temporaryValue","randomIndex","currentIndex","Math","floor","random","sortSpec","getSortSpec","sortFields","split","sortOrders","SortOrder","i","orderDesc","toLowerCase","indexOf","push","Field","OrderDescending","sort","a","b","result","compareValues","field","hasOwnProperty","valA","valB","localeCompare","getImageUrl","imageOptions","pathArray","getImagePath","type","index","imageType","parts","toString","finalParts","str","find","startsWith","substr","filterDistinct","value","self","getDirectoryPath","item","itemtype","Type","mediaType","MediaType","albumArtist","AlbumArtist","seriesName","SeriesName","seasonName","SeasonName","Album","IsFolder","Name","getValidFileName","getLocalFileName","originalFileName","filename","recordUserAction","createGuid","d","Date","getTime","window","performance","now","replace","c","r","set","getUserActions","getByServerId","deleteUserActions","actions","results","forEach","Promise","all","removeLocalItem","localItem","ServerId","then","onFileDeletedSuccessOrFail","p","resolve","LocalPath","deleteFile","Item","MediaSources","mediaSource","MediaStreams","mediaStream","Path","addOrUpdateLocalItem","downloadFile","url","imageUrl","downloadSubtitles","fileName","hasImage","localFilePath","getFullMetadataPath","fileExists","exists","err","downloadImage","localPathParts","getSubtitleSaveFileName","mediaPath","language","isForced","format","name","getNameWithoutExtension","path","pos","lastIndexOf","substring","mediaFolder","getParentPath","combinePath","getItemFileSize","isDownloadFileInQueue","getDownloadItemCount","getViews","userId","getServerItemTypes","types","list","CollectionType","getViewItems","options","searchParentId","ParentId","seasonId","SeasonId","seriesId","SeriesId","albumIds","normalizeIdList","val","map","AlbumIds","includeItemTypes","IncludeItemTypes","filters","Filters","mediaTypes","MediaTypes","updateFiltersForTopLevelView","parentId","Recursive","itemsMap","Map","subtreeIdSet","Set","LocalChildren","ignored","ignored2","has","addSubtreeIds","recurseItem","add","childItem","resultItems","filter","SyncStatus","AlbumId","item2","Limit","slice","resyncTransfers","getItemsFromIds","ids","strippedId","libItems","locItem","removeObsoleteContainerItems","seriesItems","seasonItems","albumItems","requiredSeriesIds","requiredSeasonIds","requiredAlbumIds","obsoleteItems","enableBackgroundCompletion"],"mappings":"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","file":"localassetmanager.js","sourcesContent":["define([\"filerepository\", \"itemrepository\", \"useractionrepository\", \"transfermanager\"], function(filerepository, itemrepository, useractionrepository, transfermanager) {\n    \"use strict\";\n\n    function getLocalItem(serverId, itemId) {\n        return console.debug(\"localassetmanager: begin getLocalItem\"), itemrepository.get(serverId, itemId)\n    }\n\n    function recordUserAction(action) {\n        return action.Id = createGuid(), useractionrepository.set(action.Id, action)\n    }\n\n    function getUserActions(serverId) {\n        return useractionrepository.getByServerId(serverId)\n    }\n\n    function deleteUserAction(action) {\n        return useractionrepository.remove(action.Id)\n    }\n\n    function deleteUserActions(actions) {\n        var results = [];\n        return actions.forEach(function(action) {\n            results.push(deleteUserAction(action))\n        }), Promise.all(results)\n    }\n\n    function getServerItems(serverId) {\n        return console.debug(\"localassetmanager: begin getServerItems\"), itemrepository.getAll(serverId)\n    }\n\n    function getItemsFromIds(serverId, ids) {\n        var actions = ids.map(function(id) {\n            var strippedId = stripStart(id, \"local:\");\n            return getLocalItem(serverId, strippedId)\n        });\n        return Promise.all(actions).then(function(items) {\n            var libItems = items.map(function(locItem) {\n                return locItem.Item\n            });\n            return Promise.resolve(libItems)\n        })\n    }\n\n    function getViews(serverId, userId) {\n        return itemrepository.getServerItemTypes(serverId, userId).then(function(types) {\n            var item, list = [];\n            return types.indexOf(\"Audio\") > -1 && (item = {\n                Name: \"Music\",\n                ServerId: serverId,\n                Id: \"localview:MusicView\",\n                Type: \"MusicView\",\n                CollectionType: \"music\",\n                IsFolder: !0\n            }, list.push(item)), types.indexOf(\"Photo\") > -1 && (item = {\n                Name: \"Photos\",\n                ServerId: serverId,\n                Id: \"localview:PhotosView\",\n                Type: \"PhotosView\",\n                CollectionType: \"photos\",\n                IsFolder: !0\n            }, list.push(item)), types.indexOf(\"Episode\") > -1 && (item = {\n                Name: \"TV\",\n                ServerId: serverId,\n                Id: \"localview:TVView\",\n                Type: \"TVView\",\n                CollectionType: \"tvshows\",\n                IsFolder: !0\n            }, list.push(item)), types.indexOf(\"Movie\") > -1 && (item = {\n                Name: \"Movies\",\n                ServerId: serverId,\n                Id: \"localview:MoviesView\",\n                Type: \"MoviesView\",\n                CollectionType: \"movies\",\n                IsFolder: !0\n            }, list.push(item)), types.indexOf(\"Video\") > -1 && (item = {\n                Name: \"Videos\",\n                ServerId: serverId,\n                Id: \"localview:VideosView\",\n                Type: \"VideosView\",\n                CollectionType: \"videos\",\n                IsFolder: !0\n            }, list.push(item)), types.indexOf(\"MusicVideo\") > -1 && (item = {\n                Name: \"Music Videos\",\n                ServerId: serverId,\n                Id: \"localview:MusicVideosView\",\n                Type: \"MusicVideosView\",\n                CollectionType: \"videos\",\n                IsFolder: !0\n            }, list.push(item)), Promise.resolve(list)\n        })\n    }\n\n    function updateFiltersForTopLevelView(parentId, mediaTypes, includeItemTypes, query) {\n        switch (parentId) {\n            case \"MusicView\":\n                return query.Recursive ? includeItemTypes.push(\"Audio\") : includeItemTypes.push(\"MusicAlbum\"), !0;\n            case \"PhotosView\":\n                return query.Recursive ? includeItemTypes.push(\"Photo\") : includeItemTypes.push(\"PhotoAlbum\"), !0;\n            case \"TVView\":\n                return query.Recursive ? includeItemTypes.push(\"Episode\") : includeItemTypes.push(\"Series\"), !0;\n            case \"VideosView\":\n                return query.Recursive, includeItemTypes.push(\"Video\"), !0;\n            case \"MoviesView\":\n                return query.Recursive, includeItemTypes.push(\"Movie\"), !0;\n            case \"MusicVideosView\":\n                return query.Recursive, includeItemTypes.push(\"MusicVideo\"), !0\n        }\n        return !1\n    }\n\n    function normalizeId(id) {\n        return id ? (id = stripStart(id, \"localview:\"), id = stripStart(id, \"local:\")) : null\n    }\n\n    function normalizeIdList(val) {\n        return val ? val.split(\",\").map(normalizeId) : []\n    }\n\n    function shuffle(array) {\n        for (var temporaryValue, randomIndex, currentIndex = array.length; 0 !== currentIndex;) randomIndex = Math.floor(Math.random() * currentIndex), currentIndex -= 1, temporaryValue = array[currentIndex], array[currentIndex] = array[randomIndex], array[randomIndex] = temporaryValue;\n        return array\n    }\n\n    function sortItems(items, query) {\n        if (!query.SortBy || 0 === query.SortBy.length) return items;\n        if (\"Random\" === query.SortBy) return shuffle(items);\n        var sortSpec = getSortSpec(query);\n        return items.sort(function(a, b) {\n            for (var i = 0; i < sortSpec.length; i++) {\n                var result = compareValues(a, b, sortSpec[i].Field, sortSpec[i].OrderDescending);\n                if (0 !== result) return result\n            }\n            return 0\n        }), items\n    }\n\n    function compareValues(a, b, field, orderDesc) {\n        if (!a.hasOwnProperty(field) || !b.hasOwnProperty(field)) return 0;\n        var valA = a[field],\n            valB = b[field],\n            result = 0;\n        return \"string\" == typeof valA || \"string\" == typeof valB ? (valA = valA || \"\", valB = valB || \"\", result = valA.toLowerCase().localeCompare(valB.toLowerCase())) : valA > valB ? result = 1 : valA < valB && (result = -1), orderDesc && (result *= -1), result\n    }\n\n    function getSortSpec(query) {\n        for (var sortFields = (query.SortBy || \"\").split(\",\"), sortOrders = (query.SortOrder || \"\").split(\",\"), sortSpec = [], i = 0; i < sortFields.length; i++) {\n            var orderDesc = !1;\n            i < sortOrders.length && -1 !== sortOrders[i].toLowerCase().indexOf(\"desc\") && (orderDesc = !0), sortSpec.push({\n                Field: sortFields[i],\n                OrderDescending: orderDesc\n            })\n        }\n        return sortSpec\n    }\n\n    function getViewItems(serverId, userId, options) {\n        var searchParentId = options.ParentId;\n        searchParentId = normalizeId(searchParentId);\n        var seasonId = normalizeId(options.SeasonId || options.seasonId),\n            seriesId = normalizeId(options.SeriesId || options.seriesId),\n            albumIds = normalizeIdList(options.AlbumIds || options.albumIds),\n            includeItemTypes = options.IncludeItemTypes ? options.IncludeItemTypes.split(\",\") : [],\n            filters = options.Filters ? options.Filters.split(\",\") : [],\n            mediaTypes = options.MediaTypes ? options.MediaTypes.split(\",\") : [];\n        return updateFiltersForTopLevelView(searchParentId, mediaTypes, includeItemTypes, options) && (searchParentId = null), getServerItems(serverId).then(function(items) {\n            var itemsMap = new Map,\n                subtreeIdSet = new Set;\n            if (items.forEach(function(item) {\n                    item.Item.LocalChildren = [], itemsMap.set(item.Item.Id, item.Item)\n                }), itemsMap.forEach(function(item, ignored, ignored2) {\n                    if (item.ParentId && itemsMap.has(item.ParentId)) {\n                        itemsMap.get(item.ParentId).LocalChildren.push(item)\n                    }\n                }), options.Recursive && searchParentId && itemsMap.has(searchParentId)) {\n                var addSubtreeIds = function(recurseItem) {\n                        subtreeIdSet.has(recurseItem.Id) || subtreeIdSet.add(recurseItem.Id), recurseItem.LocalChildren.forEach(function(childItem) {\n                            addSubtreeIds(childItem)\n                        })\n                    },\n                    searchParentItem = itemsMap.get(searchParentId);\n                addSubtreeIds(searchParentItem)\n            }\n            var resultItems = items.filter(function(item) {\n                return (!item.SyncStatus || \"synced\" === item.SyncStatus) && ((!mediaTypes.length || -1 !== mediaTypes.indexOf(item.Item.MediaType || \"\")) && ((!seriesId || item.Item.SeriesId === seriesId) && ((!seasonId || item.Item.SeasonId === seasonId) && ((!albumIds.length || -1 !== albumIds.indexOf(item.Item.AlbumId || \"\")) && ((!item.Item.IsFolder || -1 === filters.indexOf(\"IsNotFolder\")) && (!(!item.Item.IsFolder && -1 !== filters.indexOf(\"IsFolder\")) && ((!includeItemTypes.length || -1 !== includeItemTypes.indexOf(item.Item.Type || \"\")) && (!searchParentId || (options.Recursive ? subtreeIdSet.has(item.Item.Id) : item.Item.ParentId === searchParentId)))))))))\n            }).map(function(item2) {\n                return item2.Item\n            });\n            return resultItems = sortItems(resultItems, options), options.Limit && (resultItems = resultItems.slice(0, options.Limit)), Promise.resolve(resultItems)\n        })\n    }\n\n    function removeObsoleteContainerItems(serverId) {\n        return getServerItems(serverId).then(function(items) {\n            var seriesItems = items.filter(function(item) {\n                    return \"series\" === (item.Item.Type || \"\").toLowerCase()\n                }),\n                seasonItems = items.filter(function(item) {\n                    return \"season\" === (item.Item.Type || \"\").toLowerCase()\n                }),\n                albumItems = items.filter(function(item) {\n                    var type = (item.Item.Type || \"\").toLowerCase();\n                    return \"musicalbum\" === type || \"photoalbum\" === type\n                }),\n                requiredSeriesIds = items.filter(function(item) {\n                    return \"episode\" === (item.Item.Type || \"\").toLowerCase()\n                }).map(function(item2) {\n                    return item2.Item.SeriesId\n                }).filter(filterDistinct),\n                requiredSeasonIds = items.filter(function(item) {\n                    return \"episode\" === (item.Item.Type || \"\").toLowerCase()\n                }).map(function(item2) {\n                    return item2.Item.SeasonId\n                }).filter(filterDistinct),\n                requiredAlbumIds = items.filter(function(item) {\n                    var type = (item.Item.Type || \"\").toLowerCase();\n                    return \"audio\" === type || \"photo\" === type\n                }).map(function(item2) {\n                    return item2.Item.AlbumId\n                }).filter(filterDistinct),\n                obsoleteItems = [];\n            seriesItems.forEach(function(item) {\n                requiredSeriesIds.indexOf(item.Item.Id) < 0 && obsoleteItems.push(item)\n            }), seasonItems.forEach(function(item) {\n                requiredSeasonIds.indexOf(item.Item.Id) < 0 && obsoleteItems.push(item)\n            }), albumItems.forEach(function(item) {\n                requiredAlbumIds.indexOf(item.Item.Id) < 0 && obsoleteItems.push(item)\n            });\n            var p = Promise.resolve();\n            return obsoleteItems.forEach(function(item) {\n                p = p.then(function() {\n                    return itemrepository.remove(item.ServerId, item.Id)\n                })\n            }), p\n        })\n    }\n\n    function removeLocalItem(localItem) {\n        return itemrepository.get(localItem.ServerId, localItem.Id).then(function(item) {\n            var onFileDeletedSuccessOrFail = function() {\n                    return itemrepository.remove(localItem.ServerId, localItem.Id)\n                },\n                p = Promise.resolve();\n            return item.LocalPath && (p = p.then(function() {\n                return filerepository.deleteFile(item.LocalPath)\n            })), item && item.Item && item.Item.MediaSources && item.Item.MediaSources.forEach(function(mediaSource) {\n                mediaSource.MediaStreams && mediaSource.MediaStreams.length > 0 && mediaSource.MediaStreams.forEach(function(mediaStream) {\n                    mediaStream.Path && (p = p.then(function() {\n                        return filerepository.deleteFile(mediaStream.Path)\n                    }))\n                })\n            }), p.then(onFileDeletedSuccessOrFail, onFileDeletedSuccessOrFail)\n        }, function(item) {\n            return Promise.resolve()\n        })\n    }\n\n    function addOrUpdateLocalItem(localItem) {\n        return itemrepository.set(localItem.ServerId, localItem.Id, localItem)\n    }\n\n    function getSubtitleSaveFileName(localItem, mediaPath, language, isForced, format) {\n        var name = getNameWithoutExtension(mediaPath);\n        name = filerepository.getValidFileName(name), language && (name += \".\" + language.toLowerCase()), isForced && (name += \".foreign\"), name = name + \".\" + format.toLowerCase();\n        var mediaFolder = filerepository.getParentPath(localItem.LocalPath);\n        return filerepository.combinePath(mediaFolder, name)\n    }\n\n    function getItemFileSize(path) {\n        return filerepository.getItemFileSize(path)\n    }\n\n    function getNameWithoutExtension(path) {\n        var fileName = path,\n            pos = fileName.lastIndexOf(\".\");\n        return pos > 0 && (fileName = fileName.substring(0, pos)), fileName\n    }\n\n    function downloadFile(url, localItem) {\n        var imageUrl = getImageUrl(localItem.Item.ServerId, localItem.Item.Id, {\n            type: \"Primary\",\n            index: 0\n        });\n        return transfermanager.downloadFile(url, localItem, imageUrl)\n    }\n\n    function downloadSubtitles(url, fileName) {\n        return transfermanager.downloadSubtitles(url, fileName)\n    }\n\n    function getImageUrl(serverId, itemId, imageOptions) {\n        var imageType = imageOptions.type,\n            index = imageOptions.index,\n            pathArray = getImagePath(serverId, itemId, imageType, index);\n        return filerepository.getImageUrl(pathArray)\n    }\n\n    function hasImage(serverId, itemId, imageType, index) {\n        var pathArray = getImagePath(serverId, itemId, imageType, index),\n            localFilePath = filerepository.getFullMetadataPath(pathArray);\n        return filerepository.fileExists(localFilePath).then(function(exists) {\n            return Promise.resolve(exists)\n        }, function(err) {\n            return Promise.resolve(!1)\n        })\n    }\n\n    function fileExists(localFilePath) {\n        return filerepository.fileExists(localFilePath)\n    }\n\n    function downloadImage(localItem, url, serverId, itemId, imageType, index) {\n        var localPathParts = getImagePath(serverId, itemId, imageType, index);\n        return transfermanager.downloadImage(url, localPathParts)\n    }\n\n    function isDownloadFileInQueue(path) {\n        return transfermanager.isDownloadFileInQueue(path)\n    }\n\n    function getDownloadItemCount() {\n        return transfermanager.getDownloadItemCount()\n    }\n\n    function getDirectoryPath(item) {\n        var parts = [],\n            itemtype = item.Type.toLowerCase(),\n            mediaType = (item.MediaType || \"\").toLowerCase();\n        \"episode\" === itemtype || \"series\" === itemtype || \"season\" === itemtype ? parts.push(\"TV\") : \"video\" === mediaType ? parts.push(\"Videos\") : \"audio\" === itemtype || \"musicalbum\" === itemtype || \"musicartist\" === itemtype ? parts.push(\"Music\") : \"photo\" === itemtype || \"photoalbum\" === itemtype ? parts.push(\"Photos\") : null;\n        var albumArtist = item.AlbumArtist;\n        albumArtist && parts.push(albumArtist);\n        var seriesName = item.SeriesName;\n        seriesName && parts.push(seriesName);\n        var seasonName = item.SeasonName;\n        seasonName && parts.push(seasonName), item.Album && parts.push(item.Album), (\"video\" === mediaType && \"episode\" !== itemtype || item.IsFolder) && parts.push(item.Name);\n        for (var finalParts = [], i = 0; i < parts.length; i++) finalParts.push(filerepository.getValidFileName(parts[i]));\n        return finalParts\n    }\n\n    function getImagePath(serverId, itemId, imageType, index) {\n        var parts = [];\n        parts.push(\"images\"), index = index || 0, parts.push(itemId + \"_\" + imageType + \"_\" + index.toString());\n        for (var finalParts = [], i = 0; i < parts.length; i++) finalParts.push(parts[i]);\n        return finalParts\n    }\n\n    function getLocalFileName(item, originalFileName) {\n        var filename = originalFileName || item.Name;\n        return filerepository.getValidFileName(filename)\n    }\n\n    function resyncTransfers() {\n        return transfermanager.resyncTransfers()\n    }\n\n    function createGuid() {\n        var d = (new Date).getTime();\n        return window.performance && \"function\" == typeof window.performance.now && (d += performance.now()), \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(/[xy]/g, function(c) {\n            var r = (d + 16 * Math.random()) % 16 | 0;\n            return d = Math.floor(d / 16), (\"x\" === c ? r : 3 & r | 8).toString(16)\n        })\n    }\n\n    function startsWith(str, find) {\n        return !!(str && find && str.length > find.length && 0 === str.indexOf(find))\n    }\n\n    function stripStart(str, find) {\n        return startsWith(str, find) ? str.substr(find.length) : str\n    }\n\n    function filterDistinct(value, index, self) {\n        return self.indexOf(value) === index\n    }\n\n    function enableBackgroundCompletion() {\n        return transfermanager.enableBackgroundCompletion\n    }\n    return {\n        getLocalItem: getLocalItem,\n        getDirectoryPath: getDirectoryPath,\n        getLocalFileName: getLocalFileName,\n        recordUserAction: recordUserAction,\n        getUserActions: getUserActions,\n        deleteUserAction: deleteUserAction,\n        deleteUserActions: deleteUserActions,\n        removeLocalItem: removeLocalItem,\n        addOrUpdateLocalItem: addOrUpdateLocalItem,\n        downloadFile: downloadFile,\n        downloadSubtitles: downloadSubtitles,\n        hasImage: hasImage,\n        downloadImage: downloadImage,\n        getImageUrl: getImageUrl,\n        getSubtitleSaveFileName: getSubtitleSaveFileName,\n        getServerItems: getServerItems,\n        getItemFileSize: getItemFileSize,\n        isDownloadFileInQueue: isDownloadFileInQueue,\n        getDownloadItemCount: getDownloadItemCount,\n        getViews: getViews,\n        getViewItems: getViewItems,\n        resyncTransfers: resyncTransfers,\n        getItemsFromIds: getItemsFromIds,\n        removeObsoleteContainerItems: removeObsoleteContainerItems,\n        fileExists: fileExists,\n        enableBackgroundCompletion: enableBackgroundCompletion\n    }\n});\n"]}