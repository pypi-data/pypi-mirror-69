{"version":3,"sources":["components/skinManager.js"],"names":["define","appHost","userSettings","browser","events","pluginManager","backdrop","globalize","require","appSettings","themeStyleElement","currentThemeId","skinManager","getThemes","name","id","isDefault","isDefaultServerDashboard","loadUserSkin","options","start","Emby","Page","invokeShortcut","goHome","currentSound","themeResources","lastSound","onViewBeforeShow","e","detail","type","setBackdrop","mobile","enableThemeSongs","themeSong","playSound","Date","getTime","effect","path","volume","howler","sound","Howl","src","play","err","console","error","setTheme","context","Promise","resolve","reject","info","getThemeStylesheetInfo","isDefaultProperty","defaultTheme","selectedTheme","themes","i","length","theme","stylesheetPath","toUrl","themeId","linkUrl","unloadTheme","elem","parentNode","removeChild","link","document","createElement","setAttribute","onload","onThemeLoaded","documentElement","classList","remove","color","getComputedStyle","querySelector","getPropertyValue","setThemeColor","head","appendChild","loadThemeResources","stop","clear","addEventListener"],"mappings":"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","file":"skinManager.js","sourcesContent":["define(['apphost', 'userSettings', 'browser', 'events', 'pluginManager', 'backdrop', 'globalize', 'require', 'appSettings'], function (appHost, userSettings, browser, events, pluginManager, backdrop, globalize, require, appSettings) {\n    'use strict';\n\n    var themeStyleElement;\n    var currentThemeId;\n\n    function unloadTheme() {\n        var elem = themeStyleElement;\n        if (elem) {\n            elem.parentNode.removeChild(elem);\n            themeStyleElement = null;\n            currentThemeId = null;\n        }\n    }\n\n    function loadUserSkin(options) {\n        options = options || {};\n        if (options.start) {\n            Emby.Page.invokeShortcut(options.start);\n        } else {\n            Emby.Page.goHome();\n        }\n    }\n\n    function getThemes() {\n        return [{\n            name: \"Apple TV\",\n            id: \"appletv\"\n        }, {\n            name: \"Blue Radiance\",\n            id: \"blueradiance\"\n        }, {\n            name: \"Dark\",\n            id: \"dark\",\n            isDefault: true,\n            isDefaultServerDashboard: true\n        }, {\n            name: \"Light\",\n            id: \"light\"\n        }, {\n            name: \"Purple Haze\",\n            id: \"purplehaze\"\n        }, {\n            name: \"Windows Media Center\",\n            id: \"wmc\"\n        }];\n    }\n\n    var skinManager = {\n        getThemes: getThemes,\n        loadUserSkin: loadUserSkin\n    };\n\n    function getThemeStylesheetInfo(id, isDefaultProperty) {\n        var themes = skinManager.getThemes();\n        var defaultTheme;\n        var selectedTheme;\n\n        for (var i = 0, length = themes.length; i < length; i++) {\n\n            var theme = themes[i];\n            if (theme[isDefaultProperty]) {\n                defaultTheme = theme;\n            }\n            if (id === theme.id) {\n                selectedTheme = theme;\n            }\n        }\n\n        selectedTheme = selectedTheme || defaultTheme;\n        return {\n            stylesheetPath: require.toUrl('themes/' + selectedTheme.id + '/theme.css'),\n            themeId: selectedTheme.id\n        };\n    }\n\n    var themeResources = {};\n    var lastSound = 0;\n    var currentSound;\n\n    function loadThemeResources(id) {\n        lastSound = 0;\n        if (currentSound) {\n            currentSound.stop();\n            currentSound = null;\n        }\n\n        backdrop.clear();\n    }\n\n    function onThemeLoaded() {\n        document.documentElement.classList.remove('preload');\n        try {\n            var color = getComputedStyle(document.querySelector('.skinHeader')).getPropertyValue(\"background-color\");\n            if (color) {\n                appHost.setThemeColor(color);\n            }\n        } catch (err) {\n            console.error('error setting theme color: ' + err);\n        }\n    }\n\n    skinManager.setTheme = function (id, context) {\n        return new Promise(function (resolve, reject) {\n            if (currentThemeId && currentThemeId === id) {\n                resolve();\n                return;\n            }\n\n            var isDefaultProperty = context === 'serverdashboard' ? 'isDefaultServerDashboard' : 'isDefault';\n            var info = getThemeStylesheetInfo(id, isDefaultProperty);\n            if (currentThemeId && currentThemeId === info.themeId) {\n                resolve();\n                return;\n            }\n\n            var linkUrl = info.stylesheetPath;\n            unloadTheme();\n            var link = document.createElement('link');\n\n            link.setAttribute('rel', 'stylesheet');\n            link.setAttribute('type', 'text/css');\n            link.onload = function () {\n                onThemeLoaded();\n                resolve();\n            };\n\n            link.setAttribute('href', linkUrl);\n            document.head.appendChild(link);\n            themeStyleElement = link;\n            currentThemeId = info.themeId;\n            loadThemeResources(info.themeId);\n\n            onViewBeforeShow({});\n        });\n    };\n\n    function onViewBeforeShow(e) {\n        if (e.detail && e.detail.type === 'video-osd') {\n            return;\n        }\n\n        if (themeResources.backdrop) {\n            backdrop.setBackdrop(themeResources.backdrop);\n        }\n\n        if (!browser.mobile && userSettings.enableThemeSongs()) {\n            if (lastSound === 0) {\n                if (themeResources.themeSong) {\n                    playSound(themeResources.themeSong);\n                }\n            } else if ((new Date().getTime() - lastSound) > 30000) {\n                if (themeResources.effect) {\n                    playSound(themeResources.effect);\n                }\n            }\n        }\n    }\n\n    document.addEventListener('viewshow', onViewBeforeShow);\n\n    function playSound(path, volume) {\n        lastSound = new Date().getTime();\n        require(['howler'], function (howler) {\n            /* globals Howl */\n            try {\n                var sound = new Howl({\n                    src: [path],\n                    volume: volume || 0.1\n                });\n                sound.play();\n                currentSound = sound;\n            } catch (err) {\n                console.error('error playing sound: ' + err);\n            }\n        });\n    }\n\n    return skinManager;\n});\n"]}